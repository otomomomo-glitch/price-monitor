name: Price Monitor CI (debuggable)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */3 * * *"

jobs:
  check-price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies (pip)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            echo "Installing from requirements.txt"
            pip install -r requirements.txt
          else
            echo "No requirements.txt, installing minimal deps"
            pip install requests
          fi

      # --- Optional: force alert mode for testing ---
      # To test notifications, trigger with 'FORCE_ALERT=true' in the UI.
      - name: Run price monitor (main script)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          FORCE_ALERT: ${{ github.event.inputs.force_alert || 'false' }}
        run: |
          echo "==== RUNNING price monitor ===="
          echo "FORCE_ALERT=${FORCE_ALERT}"
          # print the script for visibility (optional)
          if [ -f src/main.py ]; then
            echo "---- src/main.py (head) ----"
            sed -n '1,200p' src/main.py || true
            echo "----------------------------"
          else
            echo "ERROR: src/main.py not found"
            exit 2
          fi

          # Run main and capture exit & stdout/stderr for logs
          python src/main.py 2>&1 | tee monitor_run.log || echo "script exit $?"
          echo "==== monitor log saved to monitor_run.log ===="
          tail -n 100 monitor_run.log || true

      # --- If you want the workflow to send only CI-level notification, keep this.
      # But per your request we prefer only price-change messages from main.py itself.
      - name: Notify Slack on failure (workflow-level fallback)
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          PYTHONPATH: src
        run: |
          echo "Sending workflow-level failure fallback to Slack"
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "No SLACK_WEBHOOK_URL set"
            exit 0
          fi
          payload="{\"text\":\"‚ùå Price Monitor workflow failed in repo ${GITHUB_REPOSITORY} (run: ${GITHUB_RUN_ID})\"}"
          curl -s -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL" || true
